/**
 * Given a list of hosts, check if the request can be responded to or if
 * the CORS headers should not be set.  No arguments or an empty argument
 * list default to all CORS headers always being set.  A host entry
 * should contain the protocol, e.g., http://example.com
 * 
 * @param {Array} hosts A list of acceptable hosts, can be empty or null.
 * @returns {Function}
 */

var exports = module.exports = function(hosts) {
    return function(req, res, next) {
        var host = "*", i, matched = false, writeHead, origin;
        if (typeof hosts !== "undefined" && hosts !== null && hosts.length > 0) {
            origin = req.header('Origin');
            if (origin === null) {
                origin = req.header('Host');
            }
            for (i = 0; i < hosts.length; i++) {
                if (hosts[i] === origin) {
                    host = hosts[i];
                    matched = true;
                    break;
                }
            }
        } else {
            matched = true;
        }

        writeHead = res.writeHead;
        function writeCORSHead(code, headers) {
            if (matched) {
                if (typeof headers === "undefined") {
                    headers = {};
                }
                headers['Access-Control-Allow-Origin'] = host;
                headers['Access-Control-Allow-Methods'] = 'GET, PUT, POST, DELETE, OPTIONS';
                headers['Access-Control-Max-Age'] = '3600';
                headers['Access-Control-Allow-Headers'] = 'X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept';
                writeHead.call(res, code, headers);
            }
        };
        res.writeHead = writeCORSHead;
        next();
    };
};
